import openpyxl
from openpyxl.styles import Font, Alignment, Border, Side, PatternFill
from openpyxl.utils import get_column_letter
from openpyxl.worksheet.datavalidation import DataValidation
from openpyxl.worksheet.table import Table, TableStyleInfo
import os
from datetime import datetime, timedelta

def add_dropdown_list(worksheet, cell_range, source, prompt_title="", prompt_text="", error_title="", error_text=""):
    """
    Добавляет выпадающий список в указанный диапазон ячеек
    
    :param worksheet: Рабочий лист
    :param cell_range: Диапазон ячеек (например, 'A1:A10')
    :param source: Источник данных (строка с перечислением или ссылка на диапазон)
    :param prompt_title: Заголовок подсказки
    :param prompt_text: Текст подсказки
    :param error_title: Заголовок ошибки
    :param error_text: Текст ошибки
    """
    validation = DataValidation(
        type="list",
        formula1=source,
        showDropDown=True,
        allow_blank=True,
        showErrorMessage=True,
        showInputMessage=True,
        errorTitle=error_title,
        error=error_text,
        promptTitle=prompt_title,
        prompt=prompt_text
    )
    worksheet.add_data_validation(validation)
    validation.add(cell_range)
    
    # Применяем стиль для лучшей видимости
    for row in worksheet[cell_range]:
        for cell in row:
            cell.style = 'Input'

def create_aosr_register(output_file):
    """
    Создает реестр актов скрытых работ с полной структурой таблиц
    """
    try:
        # Создаем новую книгу Excel
        wb = openpyxl.Workbook()
        
        # Удаляем лист по умолчанию
        if 'Sheet' in wb.sheetnames:
            wb.remove(wb['Sheet'])
        
        # Стили для оформления
        header_font = Font(bold=True, color="FFFFFF", size=12)
        header_fill = PatternFill(start_color="4472C4", end_color="4472C4", fill_type="solid")
        header_alignment = Alignment(horizontal="center", vertical="center", wrap_text=True)
        thin_border = Border(left=Side(style='thin'), 
                           right=Side(style='thin'), 
                           top=Side(style='thin'), 
                           bottom=Side(style='thin'))
        
        # 1. Лист "Сертификаты"
        ws_certs = wb.create_sheet("Сертификаты", 0)
        certs_headers = [
            "ID", "Номер сертификата", "Наименование материала", 
            "Производитель", "Дата выдачи", "Срок действия"
        ]
        ws_certs.append(certs_headers)
        
        # Тестовые данные сертификатов (15 записей)
        certs_data = [
            ["CERT-001", "СТ-РУ-001", "Бетон В25", "ООО БетонЗавод", "01.01.2023", "01.01.2026"],
            ["CERT-002", "СТ-РУ-002", "Арматура А500С", "ООО МеталлПром", "15.01.2023", "15.01.2026"],
            ["CERT-003", "СТ-РУ-003", "Кирпич керамический", "ООО КирпичЗавод", "20.01.2023", "20.01.2026"],
            ["CERT-004", "СТ-РУ-004", "Песок строительный", "ООО НерудМатериалы", "25.01.2023", "25.01.2026"],
            ["CERT-005", "СТ-РУ-005", "Цемент М500", "ООО СтройЦемент", "01.02.2023", "01.02.2026"],
            ["CERT-006", "СТ-РУ-006", "Гипсокартон", "ООО ГипсПром", "10.02.2023", "10.02.2026"],
            ["CERT-007", "СТ-РУ-007", "Плитка керамическая", "ООО Керамика", "15.02.2023", "15.02.2026"],
            ["CERT-008", "СТ-РУ-008", "Линолеум", "ООО Покрытия", "20.02.2023", "20.02.2026"],
            ["CERT-009", "СТ-РУ-009", "Краска акриловая", "ООО Лакокраска", "01.03.2023", "01.03.2026"],
            ["CERT-010", "СТ-РУ-010", "Пенополистирол", "ООО ТеплоИзоляция", "10.03.2023", "10.03.2026"],
            ["CERT-011", "СТ-РУ-011", "Металлопрофиль", "ООО МеталлКонструкции", "15.03.2023", "15.03.2026"],
            ["CERT-012", "СТ-РУ-012", "Стеклопакеты", "ООО ОкнаПлюс", "20.03.2023", "20.03.2026"],
            ["CERT-013", "СТ-РУ-013", "Двери металлические", "ООО ДверьСталь", "25.03.2023", "25.03.2026"],
            ["CERT-014", "СТ-РУ-014", "Лак паркетный", "ООО ДеревоПродукт", "01.04.2023", "01.04.2026"],
            ["CERT-015", "СТ-РУ-015", "Плиты перекрытия", "ООО ЖБИ", "10.04.2023", "10.04.2026"]
        ]
        
        for cert in certs_data:
            ws_certs.append(cert)
        
        # Создаем таблицу для сертификатов
        certs_table = Table(displayName="Сертификаты", ref=f"A1:{get_column_letter(len(certs_headers))}{len(certs_data)+1}")
        style = TableStyleInfo(name="TableStyleMedium9", showFirstColumn=False,
                              showLastColumn=False, showRowStripes=True, showColumnStripes=False)
        certs_table.tableStyleInfo = style
        ws_certs.add_table(certs_table)
        
        # 2. Лист "Организации"
        ws_orgs = wb.create_sheet("Организации", 1)
        orgs_headers = [
            "ID", "Тип", "Наименование", "ОГРН", "ИНН", 
            "Адрес", "Телефон", "СРО"
        ]
        ws_orgs.append(orgs_headers)
        
        # Тестовые данные организаций (10 строк)
        orgs_data = [
            ["ORG-001", "Заказчик", "ФГКУ Дирекция Росграницы", "1097746150292", "7709827266",
             "г.Москва, ул. Садовая-Спасская, д.18", "+7(495)785-03-34", ""],
            ["ORG-002", "Генподрядчик", "ООО СтройГарант", "1177746123456", "7712345678",
             "г.Москва, ул. Строителей, д.15", "+7(495)123-45-67", "СРО-123"],
            ["ORG-003", "Проектировщик", "ООО ПроектИнжениринг", "1187746987654", "7723456789",
             "г.Москва, Ленинский пр-т, д.42", "+7(495)234-56-78", "СРО-456"],
            ["ORG-004", "Подрядчик", "ООО СпецСтрой", "1197746543210", "7734567890",
             "г.Москва, ул. Промышленная, д.7", "+7(495)345-67-89", "СРО-789"],
            ["ORG-005", "Технадзор", "ООО ТехКонтроль", "1207746321564", "7745678901",
             "г.Москва, ул. Контрольная, д.3", "+7(495)456-78-90", "СРО-012"],
            ["ORG-006", "Подрядчик", "ООО АльфаСтрой", "1217746987456", "7756789012",
             "г.Москва, ул. Альфа, д.1", "+7(495)567-89-01", "СРО-345"],
            ["ORG-007", "Проектировщик", "ООО БетаПроект", "1227746654789", "7767890123",
             "г.Москва, ул. Бета, д.2", "+7(495)678-90-12", "СРО-678"],
            ["ORG-008", "Генподрядчик", "ООО ГаммаСтрой", "1237746321456", "7778901234",
             "г.Москва, ул. Гамма, д.3", "+7(495)789-01-23", "СРО-901"],
            ["ORG-009", "Технадзор", "ООО ДельтаКонтроль", "1247746987632", "7789012345",
             "г.Москва, ул. Дельта, д.4", "+7(495)890-12-34", "СРО-234"],
            ["ORG-010", "Подрядчик", "ООО ОмегаСтрой", "1257746543219", "7790123456",
             "г.Москва, ул. Омега, д.5", "+7(495)901-23-45", "СРО-567"]
        ]
        
        for org in orgs_data:
            ws_orgs.append(org)
        
        # Создаем таблицу для организаций
        orgs_table = Table(displayName="Организации", ref=f"A1:{get_column_letter(len(orgs_headers))}{len(orgs_data)+1}")
        orgs_table.tableStyleInfo = style
        ws_orgs.add_table(orgs_table)
        
        # 3. Лист "Персоналии"
        ws_persons = wb.create_sheet("Персоналии", 2)
        persons_headers = [
            "ID", "ФИО", "Должность", "Организация", "Причастность",
            "Телефон", "НРС", "Приказ", "Действует с"
        ]
        ws_persons.append(persons_headers)
        
        # Тестовые данные персоналий (по 2 на каждую роль)
        persons_data = [
            ["PERS-ЗАК-01", "Иванов И.И.", "Директор", "ФГКУ Дирекция Росграницы", "Заказчик", 
             "+7(495)111-11-11", "НРС-001", "Приказ №1", "01.01.2023"],
            ["PERS-ЗАК-02", "Петров П.П.", "Зам. директора", "ФГКУ Дирекция Росграницы", "Заказчик", 
             "+7(495)222-22-22", "НРС-002", "Приказ №2", "01.02.2023"],
            ["PERS-ГЕН-01", "Сидоров С.С.", "Генеральный директор", "ООО СтройГарант", "Генподрядчик", 
             "+7(495)333-33-33", "НРС-003", "Приказ №3", "01.03.2023"],
            ["PERS-ГЕН-02", "Кузнецов К.К.", "Главный инженер", "ООО СтройГарант", "Генподрядчик", 
             "+7(495)444-44-44", "НРС-004", "Приказ №4", "01.04.2023"],
            ["PERS-ТЕХ-01", "Смирнов С.С.", "Инженер технадзора", "ООО ТехКонтроль", "Технадзор", 
             "+7(495)555-55-55", "НРС-005", "Приказ №5", "01.05.2023"],
            ["PERS-ТЕХ-02", "Федоров Ф.Ф.", "Специалист технадзора", "ООО ТехКонтроль", "Технадзор", 
             "+7(495)666-66-66", "НРС-006", "Приказ №6", "01.06.2023"],
            ["PERS-ПРО-01", "Николаев Н.Н.", "Главный архитектор", "ООО ПроектИнжениринг", "Проектировщик", 
             "+7(495)777-77-77", "НРС-007", "Приказ №7", "01.07.2023"],
            ["PERS-ПРО-02", "Васильев В.В.", "Инженер-проектировщик", "ООО ПроектИнжениринг", "Проектировщик", 
             "+7(495)888-88-88", "НРС-008", "Приказ №8", "01.08.2023"],
            ["PERS-ИСП-01", "Алексеев А.А.", "Прораб", "ООО АльфаСтрой", "Исполнитель работ", 
             "+7(495)999-99-99", "НРС-009", "Приказ №9", "01.09.2023"],
            ["PERS-ИСП-02", "Дмитриев Д.Д.", "Мастер", "ООО АльфаСтрой", "Исполнитель работ", 
             "+7(495)000-00-00", "НРС-010", "Приказ №10", "01.10.2023"]
        ]
        
        for person in persons_data:
            ws_persons.append(person)
        
        # Создаем таблицу для персоналий
        persons_table = Table(displayName="Персоналии", ref=f"A1:{get_column_letter(len(persons_headers))}{len(persons_data)+1}")
        persons_table.tableStyleInfo = style
        ws_persons.add_table(persons_table)
        
        # 4. Лист "Реестр актов"
        ws_register = wb.create_sheet("Реестр актов", 3)
        register_headers = [
            "ID акта", "Суффикс", "Номер", "Наименование работ",
            "Дата начала", "Дата окончания", "Дата акта", "Последующие работы",
            "Материалы", "Исп. схемы", "Проект", 
            "Лист проекта", "Нормативные документы",
            "Статус", "Примечания",
            "Представитель заказчика", "Представитель генподрядчика",
            "Технический надзор", "Проектировщик", "Исполнитель работ"
        ]
        ws_register.append(register_headers)
        
        # Тестовые данные актов (10 строк)
        start_date = datetime(2023, 1, 1)
        act_data = []
        for i in range(1, 11):
            act_id = f"АСР-2023-{i:03d}"
            materials = f"CERT-{i:03d}; CERT-{(i%15)+1:03d}"
            
            start = start_date + timedelta(days=(i-1)*10)
            end = start + timedelta(days=5)
            act_date = end + timedelta(days=1)
            
            act_data.append([
                act_id, "АСР", str(i), f"Работы по объекту {i}",
                start.strftime("%d.%m.%Y"), end.strftime("%d.%m.%Y"), act_date.strftime("%d.%m.%Y"),
                f"Работы по объекту {i+1}" if i < 10 else "Заключительные работы",
                materials, f"Схема {i}", f"Проект-{i}",
                f"Лист {i}", "СП 48.13330.2019; СП 70.13330.2012",
                "Черновик", f"Примечание к акту {i}",
                "PERS-ЗАК-01", "PERS-ГЕН-01", "PERS-ТЕХ-01", "PERS-ПРО-01", "PERS-ИСП-01"
            ])
        
        for act in act_data:
            ws_register.append(act)
        
        # Создаем таблицу для реестра актов
        register_table = Table(
            displayName="РеестрАктов",
            ref=f"A1:{get_column_letter(len(register_headers))}{len(act_data)+1}"
        )
        register_table.tableStyleInfo = style
        ws_register.add_table(register_table)
        
        # 5. Лист "Нормативные документы"
        ws_regulations = wb.create_sheet("Нормативы", 4)
        regulations_headers = ["Код", "Наименование", "Тип", "Статус"]
        ws_regulations.append(regulations_headers)
        
        # Тестовые данные нормативов (10 строк)
        regulations_data = [
            ["СП 48.13330.2019", "Организация строительства", "СП", "Актуальный"],
            ["СП 70.13330.2012", "Несущие и ограждающие конструкции", "СП", "Актуальный"],
            ["ГОСТ 31937-2011", "Здания и сооружения. Правила обследования", "ГОСТ", "Актуальный"],
            ["СП 45.13330.2017", "Земляные сооружения", "СП", "Актуальный"],
            ["СП 22.13330.2016", "Основания зданий и сооружений", "СП", "Актуальный"],
            ["СП 63.13330.2018", "Бетонные и железобетонные конструкции", "СП", "Актуальный"],
            ["СП 16.13330.2017", "Стальные конструкции", "СП", "Актуальный"],
            ["СП 15.13330.2012", "Каменные и армокаменные конструкции", "СП", "Актуальный"],
            ["СП 64.13330.2017", "Деревянные конструкции", "СП", "Актуальный"],
            ["СП 17.13330.2017", "Кровли", "СП", "Актуальный"]
        ]
        
        for reg in regulations_data:
            ws_regulations.append(reg)
        
        # Создаем таблицу для нормативов
        regulations_table = Table(
            displayName="Нормативы",
            ref=f"A1:{get_column_letter(len(regulations_headers))}{len(regulations_data)+1}"
        )
        regulations_table.tableStyleInfo = style
        ws_regulations.add_table(regulations_table)
        
        # Настройка ширины столбцов
        def set_column_widths(ws, widths):
            for col, width in widths.items():
                ws.column_dimensions[col].width = width
        
        set_column_widths(ws_certs, {'A':10, 'B':20, 'C':30, 'D':25, 'E':12, 'F':12})
        set_column_widths(ws_orgs, {'A':10, 'B':15, 'C':40, 'D':15, 'E':15, 'F':30, 'G':15, 'H':15})
        set_column_widths(ws_persons, {'A':12, 'B':25, 'C':25, 'D':30, 'E':20, 'F':15, 'G':15, 'H':20, 'I':12})
        set_column_widths(ws_register, {'A':15, 'B':8, 'C':8, 'D':40, 'E':12, 'F':12, 'G':12, 'H':25,
                                       'I':30, 'J':20, 'K':15, 'L':15, 'M':30, 'N':15, 'O':30,
                                       'P':25, 'Q':25, 'R':25, 'S':25, 'T':25})
        set_column_widths(ws_regulations, {'A':20, 'B':40, 'C':10, 'D':12})
        
        # Добавляем выпадающие списки с помощью нашей функции
        
        # 1. Тип организации
        add_dropdown_list(
            ws_orgs, 'B2:B11', '"Заказчик,Генподрядчик,Проектировщик,Подрядчик,Технадзор"',
            "Выберите тип организации", "Пожалуйста, выберите тип организации из списка",
            "Неверный тип", "Выберите значение из списка"
        )
        
        # 2. Организация для персоналий
        add_dropdown_list(
            ws_persons, 'D2:D11', '=Организации!$C$2:$C$11',
            "Выберите организацию", "Пожалуйста, выберите организацию из списка",
            "Неверная организация", "Выберите значение из списка"
        )
        
        # 3. Материалы в реестре актов
        add_dropdown_list(
            ws_register, 'I2:I11', '=Сертификаты!$A$2:$A$16',
            "Выберите материалы", "Пожалуйста, выберите материалы из списка",
            "Неверные материалы", "Выберите значение из списка"
        )
        
        # 4. Нормативные документы
        add_dropdown_list(
            ws_register, 'M2:M11', '=Нормативы!$A$2:$A$11',
            "Выберите нормативы", "Пожалуйста, выберите нормативные документы из списка",
            "Неверные нормативы", "Выберите значение из списка"
        )
        
        # 5. Статус акта
        add_dropdown_list(
            ws_register, 'N2:N11', '"Черновик,На подписании,Подписан,Архив,Аннулирован"',
            "Выберите статус", "Пожалуйста, выберите статус акта из списка",
            "Неверный статус", "Выберите значение из списка"
        )
        
        # 6. Подписанты
        for col, role in zip(['P', 'Q', 'R', 'S', 'T'], 
                            ['Заказчик', 'Генподрядчик', 'Технадзор', 'Проектировщик', 'Исполнитель работ']):
            add_dropdown_list(
                ws_register, f'{col}2:{col}11', '=Персоналии!$A$2:$B$11',
                f"Выберите представителя {role}", f"Пожалуйста, выберите представителя {role} из списка",
                "Неверный выбор", "Выберите значение из списка"
            )
        
        # Сохраняем файл
        wb.save(output_file)
        print(f"\nРеестр успешно создан: {os.path.abspath(output_file)}")
        
        # Инструкция по проверке
        print("\nИнструкция по проверке выпадающих списков:")
        print("1. Откройте файл в Excel")
        print("2. Проверьте следующие листы:")
        print("   - 'Организации': столбец 'Тип' (выпадающий список)")
        print("   - 'Персоналии': столбец 'Организация' (выпадающий список)")
        print("   - 'Реестр актов':")
        print("     * Материалы (столбец I)")
        print("     * Нормативные документы (столбец M)")
        print("     * Статус (столбец N)")
        print("     * Подписанты (столбцы P-T)")
        
        return True
    
    except Exception as e:
        print(f"Ошибка при создании реестра: {str(e)}")
        return False

if __name__ == "__main__":
    output_filename = "Реестр_АОСР_финальный.xlsx"
    if create_aosr_register(output_filename):
        print("\nПроверка завершена успешно. Все выпадающие списки должны работать корректно.")
    else:
        print("Не удалось создать реестр. Проверьте сообщения об ошибках.")